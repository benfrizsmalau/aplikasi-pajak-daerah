<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setoran Pajak - Aplikasi Pajak Daerah</title>
    <link rel="stylesheet" href="style.css">
</head>
<body id="page-setoran-pajak">

    <header class="main-header">
        <h1>Aplikasi Pajak Daerah</h1>
        <nav>
            <a href="index.html">Dasbor</a>
            <a href="tambah-data.html">Tambah Data WP</a>
            <a href="lihat-data.html">Lihat Data WP</a>
            <a href="tambah-ketetapan.html">Buat Ketetapan</a>
            <a href="setoran-pajak.html" class="active">Setoran Pajak</a>
        </nav>
    </header>

    <main class="container">
        <h2>Form Setoran Pajak</h2>
        <p>Halaman ini akan digunakan untuk mencatat setoran pajak secara otomatis berdasarkan ketetapan yang sudah ada.</p>
        <form id="formSetoranPajak">
            <div class="form-group">
                <label for="npwpdSelect">Pilih NPWPD</label>
                <select id="npwpdSelect" required>
                    <option value="">-- Pilih NPWPD --</option>
                </select>
            </div>
            <div class="form-group">
                <label for="ketetapanSelect">Pilih Ketetapan (Belum Lunas)</label>
                <select id="ketetapanSelect" required disabled>
                    <option value="">-- Pilih Ketetapan --</option>
                </select>
            </div>
            <div class="form-group">
                <label>Nama Usaha</label>
                <input type="text" id="namaUsaha" readonly>
            </div>
            <div class="form-group">
                <label>Masa Pajak</label>
                <input type="text" id="masaPajak" readonly>
            </div>
            <div class="form-group">
                <label>Jumlah Tagihan</label>
                <input type="text" id="jumlahTagihan" readonly>
            </div>
            <div class="form-group">
                <label for="tanggalBayar">Tanggal Bayar</label>
                <input type="date" id="tanggalBayar" required>
            </div>
            <div class="form-group">
                <label for="jumlahBayar">Jumlah Bayar</label>
                <input type="number" id="jumlahBayar" required min="0">
            </div>
            <div class="form-group">
                <label for="metodeBayar">Metode Bayar</label>
                <select id="metodeBayar" required>
                    <option value="">-- Pilih Metode --</option>
                    <option value="Tunai">Tunai</option>
                    <option value="Transfer">Transfer</option>
                </select>
            </div>
            <div class="form-group">
                <label for="operator">Operator</label>
                <input type="text" id="operator" required placeholder="Nama Operator">
            </div>
            <button type="submit">Simpan Setoran</button>
            <div id="statusSetoran"></div>
        </form>
    </main>
    
    <script>
    // Konfigurasi API URL Netlify
    const apiUrl = '/.netlify/functions/api';

    let dataWajibPajak = [];
    let dataKetetapan = [];

    document.addEventListener('DOMContentLoaded', async () => {
        const npwpdSelect = document.getElementById('npwpdSelect');
        const ketetapanSelect = document.getElementById('ketetapanSelect');
        const namaUsahaInput = document.getElementById('namaUsaha');
        const masaPajakInput = document.getElementById('masaPajak');
        const jumlahTagihanInput = document.getElementById('jumlahTagihan');
        const operatorInput = document.getElementById('operator');
        const formSetoran = document.getElementById('formSetoranPajak');
        const statusSetoran = document.getElementById('statusSetoran');

        try {
            const response = await fetch(apiUrl);
            const data = await response.json();
            dataWajibPajak = data.wajibPajak || [];
            dataKetetapan = data.ketetapan || [];
            // Isi NPWPD
            npwpdSelect.innerHTML = '<option value="">-- Pilih NPWPD --</option>';
            dataWajibPajak.forEach(wp => {
                const option = document.createElement('option');
                option.value = wp.NPWPD;
                option.textContent = wp.NPWPD + ' - ' + (wp['Nama Usaha'] || '');
                npwpdSelect.appendChild(option);
            });
        } catch (error) {
            npwpdSelect.innerHTML = '<option value="">Gagal memuat data</option>';
        }

        npwpdSelect.addEventListener('change', function() {
            const selectedNpwpd = this.value;
            // Reset field
            ketetapanSelect.innerHTML = '<option value="">-- Pilih Ketetapan --</option>';
            ketetapanSelect.disabled = true;
            namaUsahaInput.value = '';
            masaPajakInput.value = '';
            jumlahTagihanInput.value = '';
            if (!selectedNpwpd) return;
            // Cari ketetapan yang belum lunas (pakai nama kolom sesuai sheet)
            const ketetapanBelumLunas = dataKetetapan.filter(k => k.NPWPD === selectedNpwpd && k.Status === 'Belum Lunas');
            if (ketetapanBelumLunas.length > 0) {
                ketetapanSelect.disabled = false;
                ketetapanBelumLunas.forEach(k => {
                    const option = document.createElement('option');
                    option.value = k.ID_Ketetapan;
                    option.textContent = k.ID_Ketetapan + ' - ' + (k.MasaPajak || '') + ' - Tagihan: ' + (k.TotalTagihan || '');
                    option.dataset.masaPajak = k.MasaPajak || '';
                    option.dataset.jumlahTagihan = k.TotalTagihan || '';
                    option.dataset.namaUsaha = (dataWajibPajak.find(wp => wp.NPWPD === selectedNpwpd)?.['Nama Usaha']) || '';
                    ketetapanSelect.appendChild(option);
                });
            }
        });

        ketetapanSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            namaUsahaInput.value = selectedOption.dataset.namaUsaha || '';
            masaPajakInput.value = selectedOption.dataset.masaPajak || '';
            jumlahTagihanInput.value = selectedOption.dataset.jumlahTagihan || '';
        });

        formSetoran.addEventListener('submit', async function(e) {
            e.preventDefault();
            statusSetoran.textContent = '';
            const idKetetapan = ketetapanSelect.value;
            const npwpd = npwpdSelect.value;
            const tanggalBayar = document.getElementById('tanggalBayar').value;
            const jumlahBayar = document.getElementById('jumlahBayar').value;
            const metodeBayar = document.getElementById('metodeBayar').value;
            const operator = operatorInput.value;
            const waktuInput = new Date().toISOString();
            const statusPembayaran = 'Sukses';
            if (!idKetetapan || !npwpd || !tanggalBayar || !jumlahBayar || !metodeBayar || !operator) {
                statusSetoran.textContent = 'Semua field wajib diisi!';
                statusSetoran.style.color = 'red';
                return;
            }
            try {
                const result = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'createPembayaran',
                        id_ketetapan: idKetetapan,
                        npwpd: npwpd,
                        tanggalBayar: tanggalBayar,
                        jumlahBayar: jumlahBayar,
                        metodeBayar: metodeBayar,
                        waktuInput: waktuInput,
                        operator: operator,
                        statusPembayaran: statusPembayaran
                    })
                });
                const resJson = await result.json();
                if (resJson.status === 'sukses') {
                    statusSetoran.textContent = 'Pembayaran berhasil dicatat!';
                    statusSetoran.style.color = 'green';
                    formSetoran.reset();
                    ketetapanSelect.disabled = true;
                    namaUsahaInput.value = '';
                    masaPajakInput.value = '';
                    jumlahTagihanInput.value = '';
                } else {
                    statusSetoran.textContent = resJson.message || 'Gagal mencatat pembayaran!';
                    statusSetoran.style.color = 'red';
                }
            } catch (err) {
                statusSetoran.textContent = 'Terjadi error saat mengirim data!';
                statusSetoran.style.color = 'red';
            }
        });
    });
    </script>
</body>
</html> 