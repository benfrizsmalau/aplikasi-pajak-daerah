<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Dokumen Fiskal - Aplikasi Pajak Daerah</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body id="page-daftar-fiskal">

    <div class="instansi-header">
        <img src="images/logo.png" alt="Logo" class="instansi-logo">
        <div class="instansi-text">
            <div class="instansi-title">APLIKASI SISTEM INFORMASI PENDAPATAN DAERAH</div>
            <div class="instansi-sub">BIDANG PENDAPATAN DAERAH</div>
            <div class="instansi-sub2">BADAN PENDAPATAN PENGELOLAAN KEUANGAN DAN ASET DAERAH KABUPATEN MAMBERAMO RAYA</div>
        </div>
    </div>

    <div class="sidebar-menu">
        <nav>
            <a href="index.html">Dasbor</a>
            <a href="tambah-data.html">Tambah Data WP</a>
            <a href="lihat-data.html">Lihat Data WP</a>
            <a href="tambah-ketetapan.html">Buat Ketetapan</a>
            <a href="daftar-ketetapan.html">Daftar Ketetapan</a>
            <a href="setoran-pajak.html">Setoran Pajak</a>
            <a href="daftar-pembayaran.html">Daftar Pembayaran</a>
            <a href="daftar-fiskal.html" class="active">Daftar Fiskal</a>
        </nav>
    </div>

    <div class="main-content">
        <main class="container">
            <h2 style="margin-bottom: 16px; color: #2c3e50; font-size: 1.4rem;">üìÑ Daftar Dokumen Fiskal</h2>
            <p style="margin-bottom: 24px; color: #666; font-size: 0.95rem;">Halaman ini menampilkan daftar NPWPD yang sudah memenuhi syarat untuk cetak dokumen fiskal (sudah lunas Pajak Reklame dan Retribusi Persampahan).</p>
            
            <div style="overflow-x:auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(60,60,120,0.08);">
                <table id="tabelFiskal" class="data-table">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>NPWPD</th>
                            <th>Nama Usaha</th>
                            <th>Pajak Reklame</th>
                            <th>Retribusi Persampahan</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="6" style="text-align: center; padding: 40px; color: #666;">Memuat data...</td></tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>
    
    <script>
    const apiUrl = '/.netlify/functions/api';
    let wajibPajakDataGlobal = [];
    document.addEventListener('DOMContentLoaded', async () => {
        const tabelBody = document.querySelector('#tabelFiskal tbody');
        try {
            const response = await fetch(apiUrl);
            const data = await response.json();
            const pembayaran = data.pembayaran || [];
            const ketetapan = data.ketetapan || [];
            const master = data.masterPajak || [];
            const wajibPajak = data.wajibPajak || [];
            wajibPajakDataGlobal = wajibPajak;
            // Kelompokkan pembayaran per NPWPD
            const npwpdMap = {};
            pembayaran.forEach(row => {
                if (!npwpdMap[row.NPWPD]) npwpdMap[row.NPWPD] = [];
                npwpdMap[row.NPWPD].push(row);
            });
            const hasil = [];
            Object.keys(npwpdMap).forEach(npwpd => {
                // Cek pembayaran lunas Pajak Reklame dan Retribusi Persampahan
                let lunasReklame = false;
                let lunasSampah = false;
                npwpdMap[npwpd].forEach(bayar => {
                    // Temukan ketetapan terkait
                    const ket = ketetapan.find(k => k.ID_Ketetapan === bayar.ID_Ketetapan);
                    if (!ket) return;
                    // Temukan master pajak terkait
                    const m = master.find(m => m.KodeLayanan === ket.KodeLayanan);
                    if (!m) return;
                    if (m.NamaLayanan && m.NamaLayanan.toLowerCase().includes('reklame') && bayar.StatusPembayaran === 'Sukses') lunasReklame = true;
                    if (m.NamaLayanan && m.NamaLayanan.toLowerCase().includes('sampah') && bayar.StatusPembayaran === 'Sukses') lunasSampah = true;
                });
                if (lunasReklame && lunasSampah) {
                    const wp = wajibPajak.find(wp => wp.NPWPD === npwpd) || {};
                    hasil.push({ npwpd, namaUsaha: wp['Nama Usaha'] || '-', namaPemilik: wp['Nama Pemilik'] || '-', alamat: wp['Alamat'] || '-' });
                }
            });
            if (hasil.length === 0) {
                tabelBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #666;">Belum ada NPWPD yang memenuhi syarat cetak dokumen fiskal.</td></tr>';
                return;
            }
            tabelBody.innerHTML = '';
            hasil.forEach((row, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${idx + 1}</td>
                    <td>${row.npwpd}</td>
                    <td>${row.namaUsaha}</td>
                    <td style="color:green;font-weight:bold;">‚úÖ Lunas</td>
                    <td style="color:green;font-weight:bold;">‚úÖ Lunas</td>
                    <td>
                        <button class="btn-cetak-fiskal" data-npwpd="${row.npwpd}" style="background: #1976d2; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">üìÑ Cetak Fiskal</button>
                        <button class="btn-delete-fiskal" data-npwpd="${row.npwpd}" style="background: #dc3545; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; margin-left: 5px;">üóëÔ∏è Delete</button>
                    </td>
                `;
                tabelBody.appendChild(tr);
            });
        } catch (err) {
            tabelBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #666;">Gagal memuat data.</td></tr>';
        }

        // Event cetak fiskal
        tabelBody.addEventListener('click', function(e) {
            if (e.target.classList.contains('btn-cetak-fiskal')) {
                const npwpd = e.target.getAttribute('data-npwpd');
                const wp = wajibPajakDataGlobal.find(wp => wp.NPWPD === npwpd) || {};
                printFiskal(npwpd, wp);
            }
            // Event delete fiskal
            if (e.target.classList.contains('btn-delete-fiskal')) {
                const npwpd = e.target.getAttribute('data-npwpd');
                if (confirm('Yakin ingin menghapus data fiskal untuk NPWPD ' + npwpd + '?')) {
                    deleteFiskal(npwpd);
                }
            }
        });
    });

    function escapeHtml(text) {
        if (!text) return '';
        return text
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function printFiskal(npwpd, wp) {
        const nomorUrut = Math.floor(100000 + Math.random() * 900000).toString();
        const tgl = new Date();
        const bulanRomawi = ['I','II','III','IV','V','VI','VII','VIII','IX','X','XI','XII'];
        const nomorDok = `${nomorUrut}/FKL/BPPKAD/${bulanRomawi[tgl.getMonth()]}/${tgl.getFullYear()}`;
        const tglCetak = tgl.toLocaleDateString('id-ID');
        const tglBerlaku = new Date(tgl.getFullYear()+1, tgl.getMonth(), tgl.getDate()).toLocaleDateString('id-ID');
        const baseUrl = window.location.origin || 'https://simpatda.mamberamoraya.go.id';
        const qrLink = `${baseUrl}/verifikasi-fiskal.html?no=${encodeURIComponent(nomorUrut)}&npwpd=${encodeURIComponent(npwpd)}`;
        const win = window.open('', '', 'width=900,height=1200');
        win.document.write('<html><head><title>Dokumen Fiskal</title><style>@media print {.btn-cetak-print{display:none!important;} #qr-fiskal{position:absolute;right:24px;bottom:24px;text-align:center;} }</style><script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script></head><body><div id="container"></div></body></html>');
        win.document.close();
        win.onload = function() {
            var d = win.document;
            var c = d.getElementById('container');
            c.style.fontFamily = 'Arial';
            c.style.maxWidth = '800px';
            c.style.margin = 'auto';
            c.style.padding = '24px';
            c.style.position = 'relative';
            // Header
            var header = d.createElement('div'); header.style.display = 'flex'; header.style.alignItems = 'center'; header.style.gap = '16px';
            var logo = d.createElement('img'); logo.src = '/images/logo.png'; logo.style.height = '70px';
            var headerText = d.createElement('div'); headerText.style.flex = '1'; headerText.style.textAlign = 'center';
            var h1 = d.createElement('div'); h1.style.fontSize = '16px'; h1.style.fontWeight = 'bold'; h1.textContent = 'PEMERINTAH KABUPATEN MAMBERAMO RAYA';
            var h2 = d.createElement('div'); h2.style.fontSize = '14px'; h2.style.fontWeight = 'bold'; h2.style.letterSpacing = '-0.5px'; h2.textContent = 'BADAN PENDAPATAN PENGELOLAAN KEUANGAN DAN ASET DAERAH';
            var h3 = d.createElement('div'); h3.style.fontSize = '12px'; h3.innerHTML = 'KOMPLEKS PERKANTORAN OTONOM, BURMESO DISTRIK MAMBERAMO TENGAH,<br>KABUPATEN MAMBERAMO RAYA, PROVINSI PAPUA';
            headerText.appendChild(h1); headerText.appendChild(h2); headerText.appendChild(h3);
            header.appendChild(logo); header.appendChild(headerText);
            c.appendChild(header);
            c.appendChild(d.createElement('hr'));
            // Judul
            var judul = d.createElement('div'); judul.style.textAlign = 'center'; judul.style.margin = '16px 0 8px 0';
            var j1 = d.createElement('div'); j1.style.fontSize = '15px'; j1.style.fontWeight = 'bold'; j1.textContent = 'FISKAL PEMBAYARAN PAJAK DAN RETRIBUSI DAERAH';
            var j2 = d.createElement('div'); j2.style.fontSize = '14px'; j2.innerHTML = 'NOMOR : <b>' + nomorDok + '</b>';
            judul.appendChild(j1); judul.appendChild(j2); c.appendChild(judul);
            // Paragraf pengantar
            var pPengantar = d.createElement('div'); pPengantar.style.margin = '24px 0 16px 0'; pPengantar.style.fontSize = '14px';
            pPengantar.textContent = 'Atas Nama Bupati Kabupaten Mamberamo Raya menerangkan bahwa Wajib Pajak dibawah ini :';
            c.appendChild(pPengantar);
            // Tabel data WP
            var tbl = d.createElement('table'); tbl.style.width = '100%'; tbl.style.marginBottom = '8px'; tbl.style.fontSize = '14px';
            var rows = [
                ['Nama Pemilik', wp['Nama Pemilik'] || '-'],
                ['Nama Usaha', wp['Nama Usaha'] || '-'],
                ['Alamat', wp['Alamat'] || '-'],
                ['NPWPD', wp.NPWPD || '-']
            ];
            rows.forEach(function(r) {
                var tr = d.createElement('tr');
                var td1 = d.createElement('td'); td1.style.width = '160px'; td1.textContent = r[0];
                var td2 = d.createElement('td'); td2.textContent = ': ' + r[1];
                tr.appendChild(td1); tr.appendChild(td2); tbl.appendChild(tr);
            });
            c.appendChild(tbl);
            // Paragraf status
            var pStatus = d.createElement('div'); pStatus.style.margin = '16px 0'; pStatus.style.fontSize = '14px';
            pStatus.textContent = 'TELAH MELAKSANAKAN KEWAJIBAN PEMBAYARAN PAJAK DAERAH DAN RETRIBUSI DAERAH DENGAN BAIK';
            c.appendChild(pStatus);
            // Paragraf keperluan
            var pKeperluan = d.createElement('div'); pKeperluan.style.marginBottom = '16px'; pKeperluan.style.fontSize = '14px';
            pKeperluan.innerHTML = 'Surat Fiskal ini diberikan atas nama pemohon yang bersangkutan untuk keperluan<br>1. Mengurus Surat Izin Jasa Konstruksi<br>2. Surat Izin Usaha Perdagangan (SIUP)<br>3. Tanda Daftar Perusahaan (TDP)';
            c.appendChild(pKeperluan);
            // Paragraf berlaku
            var pBerlaku = d.createElement('div'); pBerlaku.style.marginBottom = '16px'; pBerlaku.style.fontSize = '14px';
            pBerlaku.innerHTML = 'Surat ini berlaku sampai dengan tanggal <b>' + tglBerlaku + '</b> dan hanya berlaku untuk penggunaan di Kabupaten Mamberamo Raya.<br><br>Demikian surat Fiskal ini diberikan untuk dapat dipergunakan sebagaimana mestinya.';
            c.appendChild(pBerlaku);
            // Tanda tangan
            var ttd = d.createElement('div'); ttd.style.display = 'flex'; ttd.style.justifyContent = 'space-between'; ttd.style.fontSize = '14px'; ttd.style.marginTop = '32px';
            var ttdR = d.createElement('div'); ttdR.style.textAlign = 'center';
            ttdR.innerHTML = 'Dikeluarkan di : Burmeso<br>Pada Tanggal : ' + tglCetak + '<br><br>An. KEPALA BADAN PENDAPATAN<br>PENGELOLAAN KEUANGAN DAN ASET DAERAH<br><b>KEPALA BIDANG PENDAPATAN</b><br><br><br><br><b>HERMAN TARIBABA, SE</b><br>NIP. 197610202003121007';
            ttd.appendChild(d.createElement('div'));
            ttd.appendChild(ttdR);
            c.appendChild(ttd);
            // QR code
            var qrWrap = d.createElement('div'); qrWrap.id = 'qr-fiskal'; qrWrap.style.position = 'absolute'; qrWrap.style.right = '24px'; qrWrap.style.bottom = '24px'; qrWrap.style.textAlign = 'center';
            var qrDiv = d.createElement('div'); qrDiv.id = 'qrcode'; qrWrap.appendChild(qrDiv);
            var qrLabel = d.createElement('div'); qrLabel.style.fontSize = '10px'; qrLabel.style.color = '#888'; qrLabel.style.marginTop = '4px'; qrLabel.textContent = 'Scan QR untuk verifikasi keaslian';
            qrWrap.appendChild(qrLabel); c.appendChild(qrWrap);
            // Tombol cetak
            var btn = d.createElement('button'); btn.className = 'btn-cetak-print'; btn.textContent = 'Cetak'; btn.style.padding = '10px 24px'; btn.style.fontSize = '15px'; btn.style.cursor = 'pointer'; btn.onclick = function() { win.print(); };
            var btnWrap = d.createElement('div'); btnWrap.style.textAlign = 'center'; btnWrap.style.marginTop = '32px'; btnWrap.appendChild(btn); c.appendChild(btnWrap);
            // QR code
            if (win.QRCode && win.document.getElementById('qrcode')) {
                new win.QRCode(win.document.getElementById('qrcode'), {
                    text: qrLink,
                    width: 80,
                    height: 80
                });
            }
        };
    }

    async function deleteFiskal(npwpd) {
        try {
            const res = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'deleteFiskal', npwpd })
            });
            const result = await res.json();
            if (result.status === 'sukses') {
                alert('Data fiskal berhasil dihapus!');
                location.reload();
            } else {
                alert(result.message || 'Gagal menghapus data fiskal!');
            }
        } catch (err) {
            alert('Terjadi error saat menghapus data fiskal!');
        }
    }
    </script>
    <div class="watermark-footer">MADE BY REYNOLDS</div>
</body>
</html> 